<!-- ENTRY_ID: https://velog.io/@limseohyeon/%EA%B0%80%EC%83%81-%EB%A9%B4%EC%A0%91-%EC%82%AC%EB%A1%80%EB%A1%9C-%EB%B0%B0%EC%9A%B0%EB%8A%94-%EB%8C%80%EA%B7%9C%EB%AA%A8-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EC%84%A4%EA%B3%84-%EA%B8%B0%EC%B4%88-1%EC%9E%A5-%EC%82%AC%EC%9A%A9%EC%9E%90-%EC%88%98%EC%97%90-%EB%94%B0%EB%A5%B8-%EA%B7%9C%EB%AA%A8-%ED%99%95%EC%9E%A5%EC%84%B1-z3o36dvn -->
<!-- SOURCE_TITLE: [가상 면접 사례로 배우는 대규모 시스템 설계 기초] 1장 사용자 수에 따른 규모 확장성 -->

<h1 id="1장-사용자-수에-따른-규모-확장성">1장. 사용자 수에 따른 규모 확장성</h1>
<hr />
<h1 id="1-단일-서버">1. 단일 서버</h1>
<hr />
<p>복잡한 시스템 설계를 알아보기 전 단일 서버 실행에 대해 알아보도록 한다. 단일서버는 웹 앱, 데이터베이스, 캐시 등이 전부 서버 한 대에서 실행된다.</p>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/45265733-1f79-4af9-bdbe-3863f1bdd029/image.png" /></p>
<p><strong>단일서버 실행 과정</strong></p>
<ol>
<li>사용자 : 도메인을 이용해 웹사이트 접속</li>
<li>DNS : 도메인 → IP 변경</li>
<li>IP주소로 HTTP 요청 전달</li>
<li>웹서버 : 요청에 대해 HTML 혹은 JSON 형태의 응답 반환</li>
</ol>
<h1 id="2-수직적-규모-확장-vs-수평적-규모-확장">2. 수직적 규모 확장 vs 수평적 규모 확장</h1>
<hr />
<p>간단한 시스템의 경우 단일 서버로도 문제가 없지만 시스템 규모가 커지면 위와 같은 방법으로는 효과적이지 못하다. 이제 대규모 환경을 위한 환경을 구축하는 방법으로는 크게 <strong>스케일 업</strong>과 <strong>스케일 아웃</strong>이 있다.</p>
<h2 id="21-수직적-규모-확장스케일-업">2.1 수직적 규모 확장(스케일 업)</h2>
<p>스케일업(Scale up)이란 서버에 고사양 자원을 추가하는 행위를 말한다.</p>
<p><strong>장점</strong></p>
<ul>
<li>단순</li>
</ul>
<p><strong>단점</strong></p>
<ul>
<li>한계가 존재한다. (CPU나 메모리를 무한대로 증설 할 수 없음)</li>
<li>장애 자동복구, 다중화 불가로 서버 장애 발생시 시스템 완전 중단</li>
</ul>
<h2 id="22-수평적-규모-확장스케일-아웃">2.2 수평적 규모 확장(스케일 아웃)</h2>
<p>스케일 아웃(Scale out) 이란 더 많은 서버를 추가해 성능을 개선하는 행위를 말한다.</p>
<p><strong>스케일업의 단점 때문에 대규모 애플리케이션을 지원하는 데는 스케일 아웃이 적절하다.</strong></p>
<p><strong>이제부터 다중 서버를 구현하는 방법에 대해 알아볼 것이다.</strong></p>
<h1 id="3-데이터베이스">3. 데이터베이스</h1>
<hr />
<p>사용자가 늘면 여러 서버를 두어야 한다. 이때 서버는 웹 트래픽 처리 용도와 데이터베이스 용도로 나눌 수 있으며 아래와 같은 이점이 있다.</p>
<ul>
<li>웹 서버, DB 독립적인 확장 가능</li>
<li>부하 분산 가능</li>
</ul>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/9ac8decf-6abf-4228-a792-2245de1c7738/image.png" /></p>
<h2 id="31-데이터베이스-종류">3.1 데이터베이스 종류</h2>
<h3 id="관계형-데이터-베이스rdbms"><strong>관계형 데이터 베이스(RDBMS)</strong></h3>
<ul>
<li>자료를 테이블 열, 칼럼으로 표현</li>
<li>관계에 따라 조인(Join) 가능</li>
<li>MySQL, 오라클, PostgreSQL 등…</li>
</ul>
<h3 id="비관계형-데이터-베이스nosql"><strong>비관계형 데이터 베이스(NoSQL)</strong></h3>
<ul>
<li>키-값 저장소, 그래프 저장소, 칼럼 저장소, 문서 저장소 네 부류로 존재</li>
<li>조인(Join)연산 지원X</li>
<li>CouchDB, Neo4j, Cassandra 등…</li>
</ul>
<h3 id="언제-비관계형-데이터-베이스를-사용하는가"><strong>언제 비관계형 데이터 베이스를 사용하는가?</strong></h3>
<ul>
<li>낮은 응답 지연시간 요구</li>
<li>비정형 데이터인 경우</li>
<li>직렬화, 역직렬화만 필요한 경우</li>
<li>많은 데이터를 저장해야하는 경우</li>
</ul>
<h2 id="32-데이터베이스-다중화">3.2 데이터베이스 다중화</h2>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/7e563b2e-0160-4894-b972-00d2cf270e15/image.png" /></p>
<p>보통 서버 사이에 주(master) - 부(slave) 관계 설정하며 아래와 같은 특징을 가진다.</p>
<ul>
<li>주 서버 : 데이터 원본 저장, 쓰기 연산 지원</li>
<li>부 서버 : 데이터 사본 저장, 읽기 연산만 지원</li>
<li>보통 읽기 연산 비중 &gt; 쓰기 연산 비중 이기 때문에 부 서버가 주 서버보다 많다.</li>
</ul>
<p><strong>동작 예시</strong></p>
<ul>
<li>부 서버가 다운되는 경우 : 읽기 연산 주 서버로 인가 후 새로운 부 서버가 장애 서버 대체</li>
<li>주 서버가 다운되는 경우 : 부 서버가 주 서버로 변경, 새로운 부 서버 추가</li>
</ul>
<p>물론 실제 프로덕션 환경에서는 부 서버 보관 데이터 최신 상태를 위한 복구 스크립트, 다중 마스터, 원형 다중화 등 더 고려해야할 사항이 존재한다. </p>
<p><strong>장점</strong></p>
<ul>
<li>성능 향상 : 병렬 처리 될 수 있는 query 증가</li>
<li>안정성 : 서버 일부 파괴에도 데이터 보존 가능</li>
<li>가용성 : 서버 일부 장애에도 계속 서비스 가능</li>
</ul>
<h2 id="33-샤딩sharding">3.3 샤딩(sharding)</h2>
<p>샤딩이란 데이터베이스를 샤드(shard)라는 작은 단위로 분할하는 수평적 확장을 의미한다. 모든 샤드는 같은 스키마를 사용하지만 보관 데이터 사이에 중복은 없다.</p>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/a55ea978-a0e0-4606-855d-ad0c8cae8c78/image.png" /></p>
<p>샤딩을 도입할 때 가장 중요한 것은 샤딩 키 (혹은 파티션 키)를 어떻게 정하느냐 하는 것이다. 특히 데이터를 고르게 분할 할 수 있도록 적절한 키를 선정하는 것이 중요하다. 다음은 샤딩 도입 시 고려해야 할 것들이다.</p>
<ul>
<li>데이터의 재 샤딩<ul>
<li>데이터가 너무 많아서 하나의 샤드로  감당하기 어려울 때</li>
<li>샤드 간 데이터 분포가 균등하지 못해 샤드 소진이라는 어떤 샤드에 할당된 공간 소모가 다른 샤드에 비해 빨리 진행되는 현상이 발생할 때</li>
<li>위 두 경우가 발생하면 샤드 키 계산 함수를 변경하고 데이터를 재배치해야 한다.</li>
</ul>
</li>
<li>유명인사 문제 (핫스팟 키 문제) : 특정 샤드에 질의가 집중돼 서버에 과부하가 걸리는 문제. 경우에 따라 집중되는 질의에 샤드를 할당하거나 잘개 쪼개야한다.</li>
<li>조인과 비정규화 : 정규화시 조인하기가 임들어진다. 이에 따라 비정규화를 수행할 수도있다.</li>
</ul>
<h1 id="4-로드밸런서">4. 로드밸런서</h1>
<hr />
<p>로드밸런서는 부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 한다.</p>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/3414d5a8-a958-432a-8482-011e62057e52/image.png" /></p>
<ul>
<li>사용자는 로드밸런서의 공개 IP 주소(public IP address)로 접근한다.</li>
<li>서버 간 통신에는 사설 IP 주소(private IP address)가 이용되며 로드밸런서는 사설 주소를 이용해 웹서버와 통신한다.</li>
<li>장애 자동 복구 : 서버 1 다운 → 서버 2로 트래픽 전송 ⇒ 사이트 전체 다운 방지</li>
<li>가용성 향상 : 로드밸런서가 자동으로 트래픽 분산</li>
</ul>
<h1 id="5-캐시">5. 캐시</h1>
<hr />
<p>캐시란 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 뒤이은 요청이 빨리 처리될 수 있도록 하는 저장소다.</p>
<p>애플리케이션 성능은 데이터베이스를 얼마나 자주 호출하느냐에 크게 좌우되는데, 캐시는 이런 문제를 완화할 수 있다.</p>
<h2 id="51-캐시-계층">5.1 캐시 계층</h2>
<p>캐시 계층은 데이터가 잠시 보관되는 곳이다.</p>
<ul>
<li>데이터베이스보다 훨씬 빠르다.</li>
<li>성능 개선 &amp; 데이터베이스 부하 감소 가능</li>
<li>독립적으로 확장 가능</li>
</ul>
<p><strong>동작 예시 (우선 읽기 전략)</strong> </p>
<ol>
<li><p>웹 서버 : 캐시에 응답 저장 여부 확인</p>
<p> O → 캐시 데이터 반환 </p>
<p> X → 데이터베이스 조회 후 반환</p>
</li>
</ol>
<p>우선 읽기 전략 외에도 다양한 전략이 있는데 캐시 데이터 종류, 크기, 액세스 패턴에 맞게 전략을 선택하면 된다.</p>
<h2 id="52-캐시-사용-시-유의할-점">5.2 캐시 사용 시 유의할 점</h2>
<ul>
<li><strong>어떤 상황에 바람직한가?</strong> : 갱신은 자주 일어나지 않지만 참조가 빈번하게 일어나는 경우</li>
<li><strong>어떤 데이터를 캐시하는가?</strong> : 메모리는 휘발성 저장소로 영속성이 필요한 데이터에는 적적하지 않다.</li>
<li><strong>데이터는 어떻게 만료 되는가?</strong> : 만료된 데이터는 캐시에서 삭제되어야 하며 그렇지 않으면 캐시에 계속 남게 된다.<ul>
<li>만료 기한이 너무 짧은 경우 : 데이터베이스를 자주 읽어야 한다.</li>
<li>만료 기한이 너무 긴 경우 : 원본과 차이가 날 가능성이 높다.</li>
</ul>
</li>
<li><strong>일관성은 어떻게 유지되는가?</strong> : 일관성은 원본 - 캐시 데이터가 같은지 여부이다. 갱신 연산에 따라 일관성이 보장되지 않을 수 있으니 이에 대해 고려해 보아야 한다.</li>
<li><strong>장애를 어떻게 대처할 것인가?</strong> : 캐시 서버가 한 대만 두는 경우 단일 장애 지점(Single Point of Faliure, SPOF)가 되어버릴 가능성이 있다. SPOF를 피하려면 캐시 서버를 분산해야한다.</li>
<li><strong>캐시 메모리 크기는 어떻게 잡을 것인가? :</strong> 캐시 메모리를 과할당해 데이터가 늘어났을 때 자주 캐시에서 밀려나 성능이 저하되는 것을 방지할 수 있다.</li>
<li><strong>데이터 방출 정책은 무엇인가? :</strong> 캐시가 꽉 차는 경우 기존 데이터를 내보내야 한다.
LRU(가장 많이 쓰인다), LFU, FIFO 등이 있으며 경우에 맞게 사용하면 된다.</li>
</ul>
<h1 id="6-콘텐츠-전송-네트워크cdn">6. 콘텐츠 전송 네트워크(CDN)</h1>
<hr />
<p>CDN은 정적 콘텐츠를 전송하는 데 쓰이는 분산된 서버의 네트워크이다. 이미지, 비디오, CSS, JavaScript파일 등을 캐시할 수 있다.</p>
<p>요청 경로, 질의 문자열, 쿠키, 요청 헤더 등 HTML 페이지를 캐시하는데 즉, front용 캐시 서버라고 볼 수 있다.</p>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/9e39912b-9ba1-40fe-9be1-73a12783baed/image.png" /></p>
<p><strong>동작 예시</strong></p>
<ol>
<li>웹 사이트 방문 시 가장 가까운 CDN 서버가 정적 콘텐츠 전달\</li>
<li>사용자 A가 이미지 URL을 이용해 image.png에 접근</li>
<li>CDN 서버의 캐시에 해당 이미지가 없는 경우, 서버는 원본 서버에 요청하여 파일을 가져옴</li>
<li>본 서버가 파일을 CDN 서버에 반환</li>
<li>CDN 서버는 파일을 캐시하고 사용자 A에게 반환</li>
<li>사용자 B가 같은 이미지에 대한 요청을 CDN 서버에 전송</li>
<li>만료되지 않은 이미지에 대한 요청은 캐시를 통해 처리</li>
</ol>
<h2 id="61-cdn-고려사항">6.1 CDN 고려사항</h2>
<ul>
<li>비용: 데이터 전송 양에 따라 요금 부과되므로, 자주 사용되지 않는 컨텐츠는 빼는 것이 유리</li>
<li>적절한 만료 시한 설정: time-sensitive 한 컨텐츠의 경우 적절히 만료 시한 결정</li>
<li>CDN 장애에 대한 대처 방안: CDN 장애 시 원본 서버로 직접 가져오는 것 고려</li>
<li>컨텐츠 무효화: 만료되지 않은 컨텐츠도 특정 API를 사용하거나 버저닝을 통해 무효화 가능</li>
</ul>
<h1 id="7-무상태stateless-웹-계층">7. 무상태(stateless) 웹 계층</h1>
<hr />
<p>웹 계층의 수평적 확장을 위해선 상태정보(ex. 사용자 세션 데이터 등…)을 웹 계층에서 제거해야 한다.</p>
<p><strong>무상태 웹 계층</strong>이란 상태 정보를 지속성 저장소(RDBMS, NoSQL)에 보관하고 필요할 때 가져오록 하는 것이다.</p>
<h2 id="71-상태-정보-의존적인-아키텍처">7.1 상태 정보 의존적인 아키텍처</h2>
<p>상태 정보 의존적인 아키텍쳐에서는 상태 정보를 요청들 사이에서 공유되도록 한다. 즉, 같은 클라이언트로부터의 요청은 항상 같은 서버로 전송되어야 한다.</p>
<ul>
<li>로드밸런서에 부담이 되며 뒷단에 서버 추가/삭제 및 장애 처리 복잡</li>
</ul>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/aa8b932e-b73a-44d7-8cbc-7a2a989fd68e/image.png" /></p>
<ul>
<li>사용자A 상태 정보는 서버 1에 저장 → 사용자A 인증 HTTP 요청은 반드시 서버 2로 전송</li>
<li>사용자A 정보를 서버 2에 요청하는 경우 인증 실패</li>
</ul>
<h2 id="72-무상태-아키텍처">7.2 무상태 아키텍처</h2>
<p>공유 저장소에서 데이터를 가져옴으로써 사용자 HTTP 요청은 어떤 웹 서버로도 전달될 수 있다.</p>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/d65ab069-d923-45ed-84b0-c2e2511c5fab/image.png" /></p>
<ul>
<li>단순, 안정적, 규모 확장 쉬움</li>
</ul>
<h1 id="8-데이터-센터">8. 데이터 센터</h1>
<hr />
<p>시스템이 매우 커져서 대상 지역이 세계로 확장되는 경우 여러 데이터 센터를 지원하는 것이 필수다.</p>
<p>장애가 없는 상황에서 사용자는 가장 가까운 데이터 센터로 안내되는데, 통상 이 절차를 지리적 라우팅이라고 부른다.</p>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/c685e5a2-8286-40c9-b105-2049ce339731/image.png" /></p>
<ul>
<li>US-West 데이터 센터에 심각한 장애가 발생하면, 모든 트래픽은 장애가 없는 US-East 전달</li>
</ul>
<h3 id="다중-데이터센터-고려사항">다중 데이터센터 고려사항</h3>
<ul>
<li>트래픽 우회 : 올바른 데이터 센터로 트래픽을 보내는 효과적인 방법을 찾아야 한다.</li>
<li>데이터 동기화 : 데이터센터마다 별도의 데이터베이스를 사용하는 경우 트래픽이 다른 데이터베이스로 우회되는 경우 필요한 데이터가 없을 수 있다. 이때, 데이터를 여러 데이터 센터에 걸쳐 다중화한다.</li>
<li>테스트와 배포 : 여러 데이터 센터를 사용하는 시스템이라면, 애플리케이션을 여러 위치에서 테스트하는 것이 좋다.</li>
</ul>
<h1 id="9-메시지-큐">9. 메시지 큐</h1>
<hr />
<p>메시지 큐는 메시지의 무손실을 보장하고 비동기 통신을 지원하는 컴포넌트다.</p>
<p>메시지의 버퍼 역할을하며, 비동기적으로 전송한다.</p>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/b21233c4-07d4-46db-beb8-65d3d8a2dbcb/image.png" /></p>
<ul>
<li><strong>생산자</strong> : 메시지를 만들어 메시지 큐에 발행한다.</li>
<li><strong>소비자</strong> : 메시지 큐에서 메시지를 받아 동작을 수행한다.</li>
</ul>
<p><strong>장점</strong></p>
<ul>
<li>서비스/서버 간 결합 감소로 확장 용이</li>
<li>생산자는 소비자 프로세스가 다운되어 있어도 메시지 발행 가능</li>
<li>소비자는 생산자 서비스가 가용한 상태가 아니어도 메시지 수신 가능</li>
</ul>
<h1 id="10-로그-메트릭-그리고-자동화">10. 로그, 메트릭 그리고 자동화</h1>
<hr />
<h2 id="101-로그">10.1 로그</h2>
<p>에러 로그 모니터링을 통해 시스템 오류/문제를 쉽게 파악할 수 있다. 이때, 로그를 단일 서비스로 모으는 도구를 사용하면 더 편리하다.</p>
<h2 id="102-메트릭">10.2 메트릭</h2>
<p>메트릭을 통해 사업 현황에 유용한 정보, 시스템 현재 상태 등을 쉽게 파악할 수 있다.</p>
<ul>
<li>호스트 단위 메트릭 : CPU, 메모리, 디스크 I/O에 관한 메트릭</li>
<li>종합 메트릭 : 데이터베이스, 캐시 계층 성능 등</li>
<li>핵심 비즈니스 메트릭 : 일별 능동 사용자, 수익, 재방문 등</li>
</ul>
<h2 id="103-자동화">10.3 자동화</h2>
<p>지속적 통합, 빌드, 테스트, 배포 등의 절차 자통화 프로그램을 통해 개발 생산성을 향상 시킬 수 있다.</p>
<h1 id="11-정리">11. 정리</h1>
<hr />
<p>위 내용을 모두 반영한 설계의 최종 모습</p>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/d9d16700-5dfc-4465-9f1e-9c58cd7cf908/image.png" /></p>
<ul>
<li>웹 계층은 무상태 계층으로</li>
<li>모든 계층에 다중화 도입</li>
<li>가능한 많은 데이터를 캐시할 것</li>
<li>여러 데이터 센터를 지원할 것</li>
<li>정적 콘텐츠는 CDN을 통해 서비스할 것</li>
<li>데이터 계층은 샤딩을 통해 확장할 것</li>
<li>각 계층은 독립적 서비스로 분할할 것</li>
<li>시스템을 지속적으로 모니터링하고, 자동화 도구를 활용할 것</li>
</ul>