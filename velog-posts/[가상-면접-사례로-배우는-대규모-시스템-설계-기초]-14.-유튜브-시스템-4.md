<!-- ENTRY_ID: https://velog.io/@limseohyeon/%EA%B0%80%EC%83%81-%EB%A9%B4%EC%A0%91-%EC%82%AC%EB%A1%80%EB%A1%9C-%EB%B0%B0%EC%9A%B0%EB%8A%94-%EB%8C%80%EA%B7%9C%EB%AA%A8-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EC%84%A4%EA%B3%84-%EA%B8%B0%EC%B4%88-14.-%EA%B2%80%EC%83%89%EC%96%B4-%EC%9E%90%EB%8F%99%EC%99%84%EC%84%B1-%EC%8B%9C%EC%8A%A4%ED%85%9C -->
<!-- SOURCE_TITLE: [가상 면접 사례로 배우는 대규모 시스템 설계 기초] 14. 유튜브 시스템 -->

<h1 id="14장-유튜브-설계">14장 유튜브 설계</h1>
<hr />
<h1 id="1-문제-이해">1. 문제 이해</h1>
<aside>

<ol>
<li>메인 기능은 비디오 업로드/조회이다.</li>
<li>모바일 앱, 웹 브라우저, 스마트 TV 디바이스를 지원한다.</li>
<li>DAU는 5백만이다.</li>
<li>다국어를 지원한다.</li>
<li>해상도를 지원한다.</li>
<li>암호화가 필요하다.</li>
<li>비디오 파일은 최대 1GB로 제한한다.</li>
<li>클라우드 서비스를 사용해도 된다.</aside>

</li>
</ol>
<h1 id="2-계략적인-설계">2. 계략적인 설계</h1>
<hr />
<p><strong>비디오 업로드 절차</strong></p>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/15530638-b3a2-413b-8c3d-38327359187c/image.png" /></p>
<ul>
<li>사용즈 : 비디오 시청 이용자</li>
<li>로드밸런서 : API 서버가각으로 요청 분산</li>
<li>API 서버 : 스트리밍 제외 요청 처리</li>
<li>메타데이터 데이터베이스 : 비디오의 메타데이터 보관</li>
<li>원본 저장소 : 원본 비디오를 보관하는 이진 파일 저장소(BLOB)</li>
<li>트랜스코딩 서버 : 비디오 인코딩 제공</li>
<li>트랜스코딩 비디오 저장소 : 트랜스코딩이 완료된 비디오 저장소(BLOB)</li>
<li>CND : 비디오 캐시</li>
<li>트랜스코딩 완료 큐 : 트랜스코딩 완료 이벤트 보관 큐</li>
<li>트랜스코딩 완료 핸들러 : 완료 큐에서 데이터를 꺼내 메타데이터 캐시와 데이터베이스 갱신</li>
</ul>
<p>비디오 업로드 절차는 <strong>비디오 업로드, 메타데이터 갱신</strong> 두 프로세스가 병렬적으로 수행된다.</p>
<ol>
<li>원본 저장소에 비디오 업로드</li>
<li>트랜스코딩 서버 트랜스코딩 시작</li>
<li>트랜스코딩이 완료되면 아래 두 절차가 병렬적으로 수행됨<ol>
<li>완료된 비디오를 트랜스코딩 비디오 저장소에 업로드</li>
<li>트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣음</li>
<li>완료 핸들러가 큐에서 완료 이벤트 꺼냄</li>
<li>완료 핸들러가 메타데이터 데이터베이스와 캐시 갱신</li>
</ol>
</li>
</ol>
<p><strong>비디오 스트리밍절차</strong></p>
<ul>
<li>스트리밍 프로토콜 : 비디오 스트리밍을 위해 데이터를 전송할 때 쓰이는 표준화된 통신방법이 사용된다.<ul>
<li>종류는 MPEG-DASH. MEPEG, HLS. HLS, 스무드 스트리밍, 어도비 HTTP 동적 스트리밍 등</li>
<li>각각 지원하는 비디오 인코딩과 플레이어가 다르기 때문에 서비스 용례에 맞는 프로토콜을 골라 사용해야 한다.</li>
</ul>
</li>
<li>비디오는 CDN에서 바로 스트리밍 되기 때문에 전송지연이 낮다.</li>
</ul>
<h1 id="3-상세-설계">3. 상세 설계</h1>
<p>비디오 업로드, 비디오 스트리밍 부분에 대한 최적화 방안과 오류 처리 메커니즘에 대해 추가적으로 알아보자.</p>
<h2 id="31-비디오-트랜스코딩">3.1 비디오 트랜스코딩</h2>
<p>각기 다른 비디오 포맷을 여러 단말에서 재생하기 위해 단말과 호환되는 비트레이트와 포맷으로 저장되어야 한다. *비트레이트 : 비디오를 구성하는 비트가 얼마나 빨리 처리 되어야 하는지에 대한 값</p>
<h3 id="비디오-트랜스코딩이-필요한-이유"><strong>비디오 트랜스코딩이 필요한 이유</strong></h3>
<ul>
<li>가공되지 않은 비디오는 저장공간을 많이 차지한다.</li>
<li>상당수의 단말과 브라우저는 특정 종료의 비디오 포맷만 지원한다.</li>
<li>사용자에게 끊김 없는 고화질 비디오 재생을 제공해야 한다.</li>
<li>비디오가 끊김 없이 재생되기 위해 비디오 화질을 자동/수동으로 변경할 수 있도록 해야한다.</li>
</ul>
<h3 id="인코딩-포맷-구조">인코딩 포맷 구조</h3>
<ul>
<li>컨테이너 : 비디오 파일, 오디오, 메타데이터를 담는 바구니</li>
<li>코덱 : 압축 및 압축 해제 알고리즘</li>
</ul>
<h2 id="32-유향-비순환-그래프dag-모델">3.2 유향 비순환 그래프(DAG) 모델</h2>
<p>콘텐츠 창작자는 워터마크 등록, 섬네일 이미지 등록, 화질 설정 등 각자 자기만의 비디오 프로세싱 요구사항을 가지고 있다.</p>
<p>이에따라, 클라이언트 프로그래머로 하여금 실행할 작업을 손수 정의할 수 있도록 해야한다. DAG를 통해 작업을 단계별로 배열하고 작업들이 순차적으로 혹은 병렬적으로 실행될 수 있도록 한다.</p>
<h2 id="33-비디오-트랜스코딩-아키텍처">3.3 비디오 트랜스코딩 아키텍처</h2>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/e980646a-8bd6-48cb-8cad-156755d5a708/image.png" /></p>
<h3 id="전처리기">전처리기</h3>
<ul>
<li>비디오 분할 : 비디오 스트림을 GOP라고 불리는 단위로 쪼갠다.</li>
<li>DAG 생성 : 클라이언트 프로그래머가 작성한 설정 파일에 따라 DAG를 만든다.</li>
<li>데이터 캐시 : GOP와 메타데이터를 임시 저장소에 보관한다.</li>
</ul>
<h3 id="dag-스케줄러">DAG 스케줄러</h3>
<p>DAG스케줄러는 DAG 그래프를 단계로 분할한 후 각각을 자원 관리자의 작업 큐에 집어 넣는다.
<img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/7d9fcff2-b791-4789-a6ed-7153e7c6c6fe/image.png" /></p>
<h3 id="자원-관리자">자원 관리자</h3>
<p>자원 관리자는 자원 배분을 수행한다.</p>
<p><strong>자원 관리자 구성</strong></p>
<ul>
<li>작업 큐 : 실행할 작업 보관</li>
<li>작업 서버 큐 : 작업 서버 가용 상태 보관</li>
<li>실행 큐 :  현재 실행 중인 작업 및 작업 서버 정보 보관</li>
<li>작업 스케줄러 : 최적의 작업/서버 조합 선청 후 서버가 작업을 수행하도록 지시</li>
</ul>
<p>자원 관리자 동작</p>
<ol>
<li>작업 큐에서 작업을 꺼낸 후 실행할 작업 서버를 고른다.</li>
<li>작업 스케줄러는 작업 서버에 실행을 지시한 후 할당된 서버에 대한 정보를 실행 큐에 넣는다.</li>
<li>작업 스케줄러는 작업 종료와 함께 작업을 실행 큐에서 제거한다.</li>
</ol>
<h3 id="작업-서버">작업 서버</h3>
<p>작업 서버는 DAG에 정의된 작업을 수행한다.</p>
<h3 id="임시-저장소">임시 저장소</h3>
<p>데이터 유형, 크기, 유효기간 등에 따라 어떤 시스템을 선택할 것인지 달라진다.</p>
<p>보통 메타데이터는 크기가 작기에 메모리에 캐시해 두면 좋고, 비디오/오디오 데이터는 BLOB 저장소에 두는 것이 바람직하다.</p>
<h3 id="인코딩된-비디오">인코딩된 비디오</h3>
<p>인코딩된 비디오는 인코딩 파이프라인의 최종 결과물이다.</p>
<h2 id="34-시스템-최적화">3.4 시스템 최적화</h2>
<h3 id="속도-최적화">속도 최적화</h3>
<ul>
<li><p><strong>비디오 병렬 업로드</strong> : 비디오를 GOP로 분할해 병렬적으로 업로드 한다.</p>
</li>
<li><p><strong>업로드 센터를 사용자 근거리에 지정</strong> : 업로드 센터를 여러 곳에 둔다.</p>
</li>
<li><p><strong>모든 절차를 병렬화</strong></p>
<ul>
<li><p>메세지 큐 도입 전 : 이전 단계의 결과물이 다음 단계의 입력으로 사용되기 때문에 의존성이 높다.</p>
<p>  <img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/3a7854a4-0477-4409-bde8-d97bcbcd2a7f/image.png" /></p>
</li>
<li><p>메세지 큐 도입 후 :  뒤 모듈은 앞 작업이 끝나길 기다릴 필요 없다.</p>
<p>  <img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/5b9d5730-1bf9-4d88-a69a-1fd46c654709/image.png" /></p>
</li>
</ul>
</li>
</ul>
<h3 id="안정성-최적화">안정성 최적화</h3>
<ul>
<li><strong>미리 사인된 업로드 URL</strong> : 클라이언트는 HTTP 서버에 POST 요청을 통해 미리 사인된 URL을 받고 해당 URL이 가리키는 위치에 비디오를 업로드 한다.</li>
<li><strong>비디오 보호</strong> : 디지털 저작권 관리, AES 암호화, 워터마크를 통해 비디오 원본을 보호할 수 있다.</li>
</ul>
<h3 id="비용-최적화">비용 최적화</h3>
<p>CDN의 비용을 어떻게 낮출 수 있을까?</p>
<p>비디오 스트리밍은 롱테일 분포를 따른다. 즉, 인기 있는 비디오는 자주 재생되고 나머지는 거의 보는 사람이 없다는 것이다.</p>
<ul>
<li>인기 비디오는 CDN을 통해 재생, 나머지는 비디오 서버를 통해 재생</li>
<li>인기가 없는 비디오는 필요할 때 인코딩해 재생</li>
<li>CDN을 직접 구축하고 인터넷 서비스와 제휴 (초대형 프로젝트)</li>
</ul>
<h2 id="35-오류-처리">3.5 오류 처리</h2>
<p>시스템 오류는 두가지가 존재한다.</p>
<ul>
<li>회복 가능 오류 : 트랜스코딩 실패 등 재시도하면되는 오류</li>
<li>회복 불가능 오류 : 비디오 포맷 오류 등 작업을 중단하고 클라이언트에 알려야하는 오류</li>
</ul>
<h3 id="다양한-오류와-전형적-해결-방법">다양한 오류와 전형적 해결 방법</h3>
<ul>
<li>업로드 오류 : 재시도</li>
<li>비디오 분할 오류 : 낡은 버전의 클라이언트가 비디오 분할을 수행하지 못하는 경우 서버로 전송 후 서버가 분할을 처리하도록 함</li>
<li>트랜스코딩 오류 : 재시도</li>
<li>전처리 오류 : DAG 그래프 재생성</li>
<li>DAG 스케줄러 오류 : 작업 재 스케줄링</li>
<li>자원 관리자 큐에 장애 발생 : 사본 이용</li>
<li>작업 서버 장애 : 다른 서버에서 해당 작업 재시도</li>
<li>API 서버 장애 : 다른 API 서버로 우회</li>
<li>메타데이터 캐시 서버 장애 : 다중화로 다른 노드에서 데이터 가져온 후 장애가 난 캐시 서버 교체</li>
<li>메타데이터 데이터베이스 서버 장애<ul>
<li>주 서버 장애 : 부서버 → 주서버 변경</li>
<li>부 서버 장애 : 다른 부서버를 통해 연산 후 죽은 서버 교체</li>
</ul>
</li>
</ul>
<h1 id="4-마무리">4. 마무리</h1>
<hr />
<ul>
<li>라이브 스트리밍<ul>
<li>응답지연이 좀 더 낮아야 한다. 프로토콜 선정에 유의하자</li>
<li>병렬화 필요성이 감소한다. 작은 단위의 데이터를 실시간으로 빨리 처리해야하기 때문이다.</li>
<li>오류 처리방법에 많은 시간이 걸리는 방안은 사용하기 어렵다.</li>
</ul>
</li>
<li>비디오 삭제 : 업로드 과정에서 식별할 수도 있으나, 사용자 신고 절차로 판별할 수도 있다.</li>
</ul>