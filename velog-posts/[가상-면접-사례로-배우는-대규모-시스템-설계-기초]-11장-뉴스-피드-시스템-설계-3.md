<p>*뉴스피드 : 홈 페이지 중앙에 지속적으로 업데이트 되는 스토리</p>
<h1 id="1-문제-이해">1. 문제 이해</h1>
<aside>

<ul>
<li>웹/앱 둘 다 지원</li>
<li>스토리 읽기/쓰기 지원</li>
<li>스토리는 시간 역순 정렬</li>
<li>스토리는 미디어 파일 포함 가능</li>
<li>한 명의 사용자 최대 50,000 팔로워 지원</li>
<li>매일 천만명 정도의 트래픽 규모</aside>

</li>
</ul>
<h1 id="2-설계">2. 설계</h1>
<p>뉴스피드API는 그게 두 가지 부분으로 나뉘어져 있다.</p>
<h3 id="피드-발행-api">피드 발행 API</h3>
<p>새 스토리를 포스팅하기 위한 API</p>
<ul>
<li>POST/vi/me/feed</li>
<li>body : 포스팅 내용</li>
<li>Authorization 헤더 : API 호출 인증용</li>
</ul>
<h3 id="피드-읽기-api">피드 읽기 API</h3>
<p>뉴스 피드를 가져오는 API</p>
<ul>
<li>GET/v1/me/feed API 호출 인증용</li>
</ul>
<h1 id="3-피드-발행">3. 피드 발행</h1>
<p>아래는 피드 발행에 대한 대략적인 구조이다.</p>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/1add50fb-b4e6-40eb-8af5-822404e72a93/image.png" /></p>
<ul>
<li>사용자 : 새 포스팅 업로드</li>
<li>로드밸런서 : 트래픽 분산</li>
<li>웹 서버 : HTTP 요청 중계<ul>
<li>인증, 처리율 제한 기능</li>
<li>API를 호출하는 사용자만 포스팅 제한</li>
<li>특정 기간 한 사용자가 업로드 가능한 포스팅 수 제한</li>
</ul>
</li>
<li>포스팅 저장 서비스 : 새 포스팅 DB와 캐시에 저장</li>
<li>포스팅 전송 서비스 : 새 포스팅 친구의 피드에 푸시</li>
<li>알림 서비스 : 친구의 새 포스팅 업로드시 알림</li>
</ul>
<h2 id="22-포스팅-전송팬아웃-서비스">2.2 포스팅 전송(팬아웃) 서비스</h2>
<p>팬아웃(fanout)은 어떤 사용자의 새 포스팅을 그 사용자화 친구 관계에 있는 모든 사용자에게 전달하는 과정이다.</p>
<p>쓰기 시점의 팬아웃(fanout-on-write), 읽기 시점의 팬아웃(fanout-on-read) 두 가지 모델이 있다.</p>
<h3 id="쓰기-시점의-팬아웃fanout-on-write--push-모델">쓰기 시점의 팬아웃(fanout-on-write) / push 모델</h3>
<p>기록하는 시점에 뉴스 피드를 갱신한다.</p>
<p><strong>장점</strong></p>
<ul>
<li>뉴스 피드 실시간 갱신 가능</li>
<li>뉴스 피드 읽는 데 드는 시간 짧음</li>
</ul>
<p><strong>단점</strong></p>
<ul>
<li>핫키(hotkey) 문제 : 뉴스 피드 갱신에 많은 시간 소요되는 현상</li>
<li>자주 이용하지 않는 서비스의 피드 갱신시 컴퓨팅 자원 낭비 발생</li>
</ul>
<h3 id="읽기-시점의-팬아웃fanout-on-read--pull-모델">읽기 시점의 팬아웃(fanout-on-read) / pull 모델</h3>
<p>피드를 읽는 시점에 갱신한다.</p>
<p><strong>장점</strong></p>
<ul>
<li>로그인 전짜기 컴퓨팅 자원 소모 방지</li>
<li>핫키 문제 발생X</li>
</ul>
<p><strong>단점</strong></p>
<ul>
<li>피드 읽는데 시간 소요</li>
</ul>
<p>이에 따라, 대부분의 사용자에 대해서는 푸시 모델을 팔로워가 많은 경우 풀 모델을 사용할 수 도 있다.</p>
<h3 id="팬아웃-서비스-동작-과정">팬아웃 서비스 동작 과정</h3>
<ol>
<li>그래프 데이터베이스에서 친구ID 목록을 가져온다.</li>
<li>사용자 정보 캐시에서 정보를 가져온 뒤, 사용자 설정에 따라 필터링 한다. (ex 업데이트 무시, 공유 무시 등…)</li>
<li>친구 목록, 포스팅 ID를 메시지 큐에 넣는다.</li>
<li>팬아웃 작업 서버<ol>
<li>메시지 큐에서 데이터를 꺼내 뉴스 피드 캐시에 넣는다.</li>
<li>뉴스 피드 캐시는 &lt;포스팅 ID, 사용자 ID&gt; 순서쌍 매핑 테이블이다. 메모리 요구량 감소를 위해 ID만 보관한다.</li>
</ol>
</li>
</ol>
<h1 id="4-피드-읽기">4. 피드 읽기</h1>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/18c807d0-dd8b-4ab6-8b34-2835f3bfdb8b/image.png" /></p>
<ul>
<li>사용자 : 뉴스 피드를 읽는다.</li>
<li>로드 밸런서 : 트래픽을 분산한다.</li>
<li>웹 서버 : 트래픽을 뉴스 피드 서비스로 보낸다.</li>
<li>뉴스 피드 서비스 : 캐시에서 뉴스 피드를 가져온다.</li>
<li>뉴스 피드 캐시 : 뉴스 피드 렌더링을 위한 피드 ID를 보관한다.</li>
</ul>
<h2 id="41-피드-읽기-상세">4.1 피드 읽기 상세</h2>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/ffbbf4fa-8f77-46a4-9f1c-ef92672a546c/image.png" /></p>
<ul>
<li>미디어 콘텐츠는 CDN을 이용해 속도를 향상시킨다.</li>
</ul>
<ol>
<li>사용자 : 요청 전송</li>
<li>로드밸런서 : 요청을 웹 서버로 전송</li>
<li>웹 서버 : 뉴스 피드 서비스 호출</li>
<li>뉴스 피드 서비스 : 뉴스 피드 캐시에서 포스팅 ID 목록 읽음</li>
<li>사용자 이름, 사진, 포스팅 콘텐츠, 이미지 등을 사용자 캐시와 포스팅 캐시에서 읽음</li>
<li>위 데이터로 뉴스피드 생성 후 JSON 현태로 클라이언트에 전송</li>
<li>클라이언트 : 해당 피드 렌더링</li>
</ol>
<h2 id="42-캐시-구조">4.2 캐시 구조</h2>
<p><img alt="" src="https://velog.velcdn.com/images/limseohyeon/post/f7fa38d3-04b7-41e9-bcdb-edd9c597806b/image.png" /></p>
<ul>
<li>뉴스 피드 : 뉴스 피드의 ID 보관</li>
<li>콘텐츠 : 포스팅 데이터, 인기 콘텐츠 따로 보관</li>
<li>소셜 그래프 : 사용자간 관계 정보 보관</li>
<li>행동 : 포스팅에 대한 행위 정보 보관 ex) 좋아요, 답글 등…</li>
<li>횟수 : 좋아요 횟수, 응답 수 등 정보 보관</li>
</ul>